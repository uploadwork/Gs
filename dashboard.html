<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">



  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #f7f7f8;
      color: #1d1d1f;
    }
    .container {
      max-width: 420px;
      margin: 0 auto;
      padding-bottom: 80px;
    }
    header {
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header .text {
      font-size: 14px;
      color: #6e6e73;
    }
    header h2 {
      margin: 4px 0 0;
      font-size: 20px;
      font-weight: 700;
    }
    header .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f1edff;
      color: #7a5cff;
      font-weight: bold;
      font-size: 18px;
      text-transform: uppercase;
    }
    /* Balance Card */
    .balance-card {
      margin: 0 20px;
      padding: 20px;
      border-radius: 20px;
      background: linear-gradient(135deg, #7a5cff, #9f87ff);
      color: #fff;
      position: relative;
    }
    .balance-card .label {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .balance-card .amount {
      font-size: 28px;
      font-weight: 800;
      margin-top: 8px;
    }
    .balance-card .plus {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 44px;
      height: 44px;
      border-radius: 16px;
      background: rgba(255,255,255,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    /* Quick actions */
    .actions {
      margin: 20px;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 14px;
    }
    .action {
      background: #fff;
      border-radius: 16px;
      padding: 14px 6px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      text-align: center;
      font-size: 13px;
      font-weight: 500;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .eye-slash { display: none; }
    .action svg {
      width: 22px;
      height: 22px;
      margin-bottom: 6px;
      stroke: #6a55ff;
    }
    /* Tips */
    .tips {
      margin: 0 20px 20px;
      background: #fff;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .tips h3 {
      font-size: 15px;
      font-weight: 700;
      color: #7a5cff;
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0 0 6px;
    }
    .tips p {
      margin: 0;
      font-size: 14px;
      color: #444;
    }
    /* Account Progress */
    .progress {
      margin: 0 20px 100px;
      background: #fff;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .progress h3 {
      font-size: 15px;
      font-weight: 700;
      color: #7a5cff;
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0 0 10px;
    }
    .tiers {
      display: flex;
      gap: 10px;
    }
    .tier {
      flex: 1;
      padding: 10px;
      border-radius: 12px;
      text-align: center;
      font-weight: 600;
      font-size: 14px;
      background: #f0f0ff;
      color: #666;
    }
    .tier.active {
      background: #7a5cff;
      color: #fff;
    }
    .bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: #fff;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
    }
    .bottom-nav a {
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      color: #666;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .bottom-nav a.active {
      color: #7a5cff;
    }
    .bottom-nav svg {
      width: 26px;
      height: 26px;
      margin-bottom: 3px;
    }
    .notif-dot {
      display: block;
      width: 8px;
      height: 8px;
      background: red;
      border-radius: 50%;
      position: absolute;
      top: 4px;
      right: 22px;
    }
  
    .file-chip {
      display: inline-block;
      padding: 8px 14px;
      background: #7a5cff;
      color: #fff;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
    }
    #filePreview img {
      margin-top: 10px;
      max-width: 120px;
      max-height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #eee;
    }
    .deposit-btn {
      margin-top: 15px;
      background: #7a5cff;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

  
    input, textarea, select {
      font-size: 16px; /* prevents zoom on mobile */
    }

  
    input, textarea, select {
      font-size: 16px; /* prevents zoom */
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #7a5cff;
      box-shadow: 0 0 0 2px rgba(122, 92, 255, 0.2);
    }

  
    .file-chip {
      display: inline-block;
      padding: 10px 16px;
      background: #7a5cff;
      color: #fff;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.3s, transform 0.2s;
    }
    .file-chip:hover {
      background: #6a4be0;
      transform: scale(1.05);
    }
    .file-chip:active {
      transform: scale(0.97);
    }

  
    .file-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .file-chip img {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      object-fit: cover;
    }

  
    #chipClear {
      font-size: 14px;
      color: #fff;
      background: #e74c3c;
      border-radius: 50%;
      padding: 2px 6px;
      line-height: 1;
    }
    #chipClear:hover {
      background: #c0392b;
    }

  
    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .file-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #7a5cff;
      color: #fff;
      border-radius: 20px;
      cursor: default;
      font-size: 14px;
    }
    .file-chip img {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      object-fit: cover;
    }
    .file-chip .chipClear {
      font-size: 14px;
      color: #fff;
      background: #e74c3c;
      border-radius: 50%;
      padding: 0 5px;
      cursor: pointer;
    }
    .file-chip .chipClear:hover {
      background: #c0392b;
    }
/* ---- payment methods UI ---- */
.payment-method {
  margin: 8px 0;
  padding: 8px 10px;
  border-radius: 10px;
  background: #fbfbff;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  border: 1px solid #f0efff;
  font-size: 14px;
}
.payment-method .meta { color: #444; font-size: 13px; opacity: 0.95; }
.payment-method .controls { display:flex; gap:6px; align-items:center; }
.copy-btn {
  padding: 6px 8px;
  border-radius: 8px;
  border: none;
  background: #7a5cff;
  color: #fff;
  font-weight: 700;
  cursor: pointer;
  font-size: 13px;
}
.copy-btn.secondary { background: #eee; color: #333; font-weight:600; }

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <p id="greeting">Hi, <span id="username"></span></p>
        <h2 id="timeGreeting"></h2>
      </div>
      <div id="profileBadge" class="avatar"></div>
    </header>

    <div class="balance-card">
      <div class="label">
  Balance
  <svg id="toggleBalance" xmlns="http://www.w3.org/2000/svg" fill="none"
       viewBox="0 0 24 24" stroke="#fff" stroke-width="1.8"
       style="cursor:pointer; width:22px; height:22px;">
    <!-- 👁 Eye Open -->
    <path class="eye-open" stroke-linecap="round" stroke-linejoin="round"
          d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7S1 12 1 12z"/>
    <circle class="eye-open" cx="12" cy="12" r="3"/>
    
    <!-- 👁 Eye Slash (hidden by default) -->
    <path class="eye-slash" stroke-linecap="round" stroke-linejoin="round"
          d="M17.94 17.94A10.94 10.94 0 0112 19c-7 0-11-7-11-7
             a21.77 21.77 0 015.06-5.94m3.5-2.06A10.94 10.94 0 0112 5c7 0 11 7 11 7
             a21.77 21.77 0 01-2.06 3.12M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
    <line class="eye-slash" x1="3" y1="3" x2="21" y2="21"/>
  </svg>
</div>
      <div class="amount" id="balanceAmount"></div>
      <div class="plus">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke="#fff" stroke-width="2.5"
             style="width:22px; height:22px;">
          <line x1="12" y1="5" x2="12" y2="19"/>
          <line x1="5" y1="12" x2="19" y2="12"/>
        </svg>
      </div>
    </div>

    <div class="actions">
      <div class="action">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path d="M7 10l5-5 5 5"/>
          <path d="M12 5v14"/>
        </svg>
        Withdraw
      </div>
      <div class="action">
  <svg xmlns="http://www.w3.org/2000/svg" 
       viewBox="0 0 24 24" 
       fill="none" stroke="currentColor" 
       stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
       style="width: 24px; height: 24px;">
    <path d="M4 4v5h.5M20 20v-5h-.5M4.5 9A7.5 7.5 0 0120 15.5M19.5 15A7.5 7.5 0 014 8.5"/>
  </svg>
  Change Currency
</div>
      <div class="action">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <rect x="3" y="5" width="18" height="14" rx="2" ry="2"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        Add Payment Method
      </div>
      <div class="action">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <circle cx="12" cy="12" r="9"/>
          <polyline points="12,6 12,12 16,14"/>
        </svg>
        Transaction History
      </div>
    </div>

    <div class="tips">
      <h3>
  <!-- Lightbulb Icon -->
  <svg xmlns="http://www.w3.org/2000/svg" 
       width="20" height="20" viewBox="0 0 24 24" 
       fill="none" stroke="currentColor" stroke-width="2" 
       stroke-linecap="round" stroke-linejoin="round"
       style="color:#f1c40f;">
    <path d="M9 18h6"/>
    <path d="M10 22h4"/>
    <path d="M12 2a7 7 0 0 0-7 7c0 3.07 1.63 4.92 3 6h8c1.37-1.08 3-2.93 3-6a7 7 0 0 0-7-7z"/>
  </svg>
  Tips & Insights
</h3>
      <p>Set up a payment method for faster withdrawals.</p>
    </div>

    <div class="progress">
      <h3>
  <!-- Bar Chart Icon -->
  <svg xmlns="http://www.w3.org/2000/svg" 
       width="20" height="20" viewBox="0 0 24 24" 
       fill="none" stroke="currentColor" stroke-width="2" 
       stroke-linecap="round" stroke-linejoin="round"
       style="color:#7a5cff;">
    <line x1="12" y1="20" x2="12" y2="10"/>
    <line x1="18" y1="20" x2="18" y2="4"/>
    <line x1="6" y1="20" x2="6" y2="16"/>
  </svg>
  Account Progress
</h3>
      <div class="tiers">
  <div class="tier active" data-tier="1">Tier 1</div>
  <div class="tier" data-tier="2">Tier 2</div>
  <div class="tier" data-tier="3">Tier 3</div>
</div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <a href="#" class="active">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path d="M3 11l9-7 9 7"/>
        <path d="M9 22V12h6v10"/>
      </svg>
      <span>Home</span>
    </a>
    <a href="#">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="bell">
        <path d="M15 17h5l-1.4-1.4A2 2 0 0118 14V11a6 6 0 10-12 0v3c0 .5-.2 1-.6 1.4L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
      </svg>
      <span>Notifications</span>
      <span class="notif-dot"></span>
    </a>
  </nav>

  
  
  
  <!-- Profile Modal and styles -->
  <style>
    /* Modal styles (added) */
    .modal {
      display: none; 
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      width: 280px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      position: relative;
    }
    .logout-btn {
      margin-top: 15px;
      background: #7a5cff;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .logout-btn svg { width: 20px; height: 20px; stroke: #fff; }
    .close {
      position: absolute;
      top: 10px;
      right: 12px;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      color: #7a5cff;
    }
  
    .file-chip {
      display: inline-block;
      padding: 8px 14px;
      background: #7a5cff;
      color: #fff;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
    }
    #filePreview img {
      margin-top: 10px;
      max-width: 120px;
      max-height: 120px;
      object-fit: cover;
      border-radius: 8px;
      border: 2px solid #eee;
    }
    .deposit-btn {
      margin-top: 15px;
      background: #7a5cff;
      color: #fff;
      border: none;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
    }

  
    input, textarea, select {
      font-size: 16px; /* prevents zoom */
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-sizing: border-box;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #7a5cff;
      box-shadow: 0 0 0 2px rgba(122, 92, 255, 0.2);
    }

  
    .file-chip {
      display: inline-block;
      padding: 10px 16px;
      background: #7a5cff;
      color: #fff;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.3s, transform 0.2s;
    }
    .file-chip:hover {
      background: #6a4be0;
      transform: scale(1.05);
    }
    .file-chip:active {
      transform: scale(0.97);
    }

  
    .file-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .file-chip img {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      object-fit: cover;
    }

  
    #chipClear {
      font-size: 14px;
      color: #fff;
      background: #e74c3c;
      border-radius: 50%;
      padding: 2px 6px;
      line-height: 1;
    }
    #chipClear:hover {
      background: #c0392b;
    }

  
    .chip-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .file-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: #7a5cff;
      color: #fff;
      border-radius: 20px;
      cursor: default;
      font-size: 14px;
    }
    .file-chip img {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      object-fit: cover;
    }
    .file-chip .chipClear {
      font-size: 14px;
      color: #fff;
      background: #e74c3c;
      border-radius: 50%;
      padding: 0 5px;
      cursor: pointer;
    }
    .file-chip .chipClear:hover {
      background: #c0392b;
    }
    #tierUpgradeModal svg {
  filter: drop-shadow(0 2px 6px rgba(0,0,0,0.2));
}

  </style>

 <!-- Manage Payment Methods Modal -->
<div id="managePaymentModal" class="modal">
  <div class="modal-content" style="max-width:340px;">
    <span class="close" id="closeManagePayment" style="cursor:pointer;">&times;</span>
    <h3>Manage Payment Methods</h3>

    <form id="addPaymentForm" style="margin-top:8px;">
  <select id="pmType" required style="margin-bottom:8px;">
    <option value="">Select method</option>
    <option value="GCash">GCash</option>
    <option value="Bank">Bank Transfer</option>
    <option value="CashApp">Cash App</option>
    <option value="PayPal">PayPal</option>
    <option value="Wallet">Wallet</option>
    <option value="Other">Other</option>
  </select>
  <!-- Optional label (hidden if you don’t want user to edit name) -->
  <input type="hidden" id="pmLabel">

  <!-- Dynamic fields will appear here -->
  <div id="pmDynamicFields"></div>

  <div style="display:flex; gap:8px; margin-top:12px;">
    <button type="submit" class="deposit-btn" style="flex:1;">Save</button>
    <button type="button" id="cancelAddPayment" class="deposit-btn" style="flex:1; background:#ddd; color:#111;">Cancel</button>
  </div>
</form>

    <div style="margin-top:14px;">
      <h4 style="margin:6px 0;">Your Methods</h4>
      <div id="myPaymentMethods"></div>
    </div>
  </div>
</div>

 <!-- Deposit Modal -->
<div id="depositModal" class="modal">
  <div class="modal-content">
    <span id="closeDeposit" class="close">&times;</span>
    <h3>Deposit Funds</h3>
    <div id="adminDetails" style="margin:10px 0; font-size:15px; font-weight:500;"></div>
    <p style="color:#e74c3c; font-size:13px; font-weight:600; margin:8px 0 12px;">
<!-- Payment Methods from Admin -->
   <div class="section">
  <h4>Available Payment Methods</h4>
  <div id="depositPaymentOptions"></div>
<div id="userPaymentMethods"></div>
    </div>

 
      ⚠️ Please make your payment externally and upload the correct slip as proof.<br>
      ✅ Funds will be added after Slip Confirmation.
    </p>
    <form id="depositForm">
      <input type="number" id="depositAmount" placeholder="Enter amount" required min="10"><br><br>
      <div id="chipContainer" class="chip-container">
  <!-- This stays permanently -->
  <label for="depositFile" class="file-chip upload-trigger" id="uploadSlipLabel">
  <span>📁 Upload Slip</span>
</label>
</div>
<!-- Hidden file input -->
<input type="file" id="depositFile" accept="image/*" multiple style="display:none;">
      <br>
      <button type="submit" class="deposit-btn" style="display:flex;align-items:center;justify-content:center;gap:8px;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
             stroke="currentColor" width="18" height="18">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1M12 12V4m0 0l-4 4m4-4l4 4"/>
        </svg>
        Submit Deposit
      </button>
    </form>
  </div>
</div>

<!-- Buy PIN Modal -->
<div class="modal" id="pinBuyModal">
  <div class="modal-content">
    <span class="close" id="closePinBuy">&times;</span>
    <h3>Buy Activation PIN</h3>
    <form id="pinBuyForm">
      <div id="pinInstructions" style="margin-bottom:12px; font-size:14px; font-weight:500; color:#333;">
        <!-- Admin instructions will appear here -->
      </div>
      <div class="input-group">
        <label for="pinBuyFile">Upload Payment Slip</label>
        <input type="file" id="pinBuyFile" accept="image/*" required>
        <div id="pinBuyChipContainer" class="chip-container"></div>
      </div>
      <div id="userPaymentMethods"></div>
      <button type="submit" class="deposit-btn">Submit PIN Request</button>
    </form>
  </div>
</div>
<!-- PIN Received Modal -->
<div class="modal" id="pinReceivedModal">
  <div class="modal-content" style="max-width:400px; text-align:center;">
    <span class="close" id="closePinReceived">&times;</span>
    <div id="pinReceivedMessage"></div>
  </div>
</div>
<!-- Change Currency Modal -->
<div id="currencyModal" class="modal">
  <div class="modal-content" style="max-width:320px; text-align:left;">
    <span class="close" id="closeCurrency">&times;</span>
    <h3>Change Currency</h3>
    <input id="currencySearch" type="text" placeholder="Search currency..." style="margin:10px 0; padding:10px 12px; width:100%; box-sizing:border-box;">
    <div id="currencyList" style="max-height:260px; overflow-y:auto; border-radius:8px; border:1px solid #f4f4fb;"></div>
  </div>
</div>
<!-- Withdraw Modal -->
<div id="withdrawModal" class="modal">
  <div class="modal-content">
    <span id="closeWithdraw" class="close">&times;</span>
    <h3>Withdraw Funds</h3>
    <form id="withdrawForm">
      <input type="number" id="withdrawAmount" placeholder="Enter amount" required min="20"><br><br>
      <!-- Show selected method -->
<div id="withdrawMethodDisplay"
     style="margin:12px 0; padding:10px; background:#f9f9f9; border:1px solid #eee; border-radius:6px;">
  <em>No payment method set.</em>
</div>

<!-- Edit button -->
<button type="button" id="editPaymentBtn"
        style="margin-bottom:10px; background:#ddd; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">
  Edit Payment Method
</button>
      <button type="submit" class="deposit-btn" style="display:flex;align-items:center;justify-content:center;gap:8px;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M12 8c-1.657 0-3 1.343-3 3h6c0-1.657-1.343-3-3-3zm0 0V5m0 6v6m-7 0h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>
        </svg>
        Proceed to Withdraw
      </button>
    </form>
  </div>
</div>  <!-- PIN Prompt Modal -->
<div id="pinModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Enter Activation PIN</h3>
    <form id="pinForm">
      <input type="password" id="activationPin" placeholder="Enter PIN" required><br><br>
      <button type="submit" class="deposit-btn" style="display:flex;align-items:center;justify-content:center;gap:8px;">
        <!-- Lock Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M12 11c.828 0 1.5.672 1.5 1.5S12.828 14 12 14s-1.5-.672-1.5-1.5S11.172 11 12 11zM6 10V8a6 6 0 1112 0v2m-9 0h6a2 2 0 012 2v7a2 2 0 01-2 2H9a2 2 0 01-2-2v-7a2 2 0 012-2z"/>
        </svg>
        Confirm Withdrawal
      </button>
    </form>
    <div style="margin-top:12px; display:flex; justify-content:space-between; gap:10px;">
      <button id="buyPinBtn" style="flex:1; background:#27ae60; color:#fff; padding:10px; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
        <!-- Cart Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-1.35 2.7a1 1 0 00.9 1.45h12.9m-9 4a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z"/>
        </svg>
        Buy PIN
      </button>
      <button id="learnMoreBtn" style="flex:1; background:#2980b9; color:#fff; padding:10px; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px;">
        <!-- Info Icon -->
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                d="M13 16h-1v-4h-1m1-4h.01M21 12A9 9 0 113 12a9 9 0 0118 0z"/>
        </svg>
        Learn More
      </button>
    </div>
  </div>
</div>
<!-- Learn More Modal -->
<div id="learnMoreModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeLearnMore">&times;</span>
    
    <h2>
      <svg xmlns="http://www.w3.org/2000/svg" 
           width="24" height="24" viewBox="0 0 24 24" 
           fill="none" stroke="#2980b9" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round" 
           style="vertical-align: middle; margin-right: 8px;">
        <circle cx="12" cy="12" r="10"/>
        <line x1="12" y1="16" x2="12" y2="12"/>
        <line x1="12" y1="8" x2="12" y2="8"/>
      </svg>
      About Activation PIN
    </h2>

    <p>
      The <strong>Activation PIN</strong> is a security measure designed to protect your account and prevent unauthorized withdrawals.
    </p>

    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" 
           width="20" height="20" viewBox="0 0 24 24" 
           fill="none" stroke="green" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round" 
           style="vertical-align: middle; margin-right: 6px;">
        <path d="M12 1a9 9 0 0 0-9 9v4a4 4 0 0 0 4 4h1v2a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-2h1a4 4 0 0 0 4-4v-4a9 9 0 0 0-9-9z"/>
      </svg>
      Why it’s important
    </h3>
    <ul>
      <li>Ensures only you can authorize withdrawals</li>
      <li>Protects your funds against unauthorized access</li>
      <li>Acts as a second layer of verification</li>
    </ul>

    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" 
           width="20" height="20" viewBox="0 0 24 24" 
           fill="none" stroke="orange" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round" 
           style="vertical-align: middle; margin-right: 6px;">
        <circle cx="12" cy="12" r="10"/>
        <path d="M12 8v4l3 3"/>
      </svg>
      How to get your PIN
    </h3>
    <ul>
      <li>Purchase one instantly via the <strong>“Buy PIN”</strong> option</li>
      <li>Or request one directly from the from your project manager</li>
    </ul>

    <h3>
      <svg xmlns="http://www.w3.org/2000/svg" 
           width="20" height="20" viewBox="0 0 24 24" 
           fill="none" stroke="red" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round" 
           style="vertical-align: middle; margin-right: 6px;">
        <path d="M10.29 3.86L1.82 18a1.5 1.5 0 0 0 1.29 2.25h17.78A1.5 1.5 0 0 0 22.18 18L13.71 3.86a1.5 1.5 0 0 0-2.42 0z"/>
        <line x1="12" y1="9" x2="12" y2="13"/>
        <line x1="12" y1="17" x2="12" y2="17"/>
      </svg>
      Keep it safe
    </h3>
    <p>
      Never share your Activation PIN with anyone. If you believe it has been compromised, request a new one immediately.
    </p>
  </div>
</div>
<!-- Transaction History Modal -->
<div id="historyModal" class="modal">
  <div class="modal-content" style="max-width:400px; text-align:left;">
    <span class="close" id="closeHistory" style="cursor:pointer;">&times;</span>
    <h3>Transaction History</h3>
    <div id="transactionHistory" style="max-height:300px; overflow-y:auto; margin-top:12px;">
      <em>No transactions yet.</em>
    </div>
  </div>
</div>
  
  <!-- Notification Modal -->
  <div id="notifyModal" class="modal">
    <div class="modal-content">
      <h3 id="notifyMessage"></h3>
      <button id="notifyClose" class="deposit-btn" style="display:flex;align-items:center;justify-content:center;gap:8px;">
  <!-- Check Icon -->
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
       stroke="currentColor" width="18" height="18">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M5 13l4 4L19 7"/>
  </svg>
  OK
</button>
    </div>
  </div>
  
<!-- Generic Tier Upgrade Modal -->
<div id="tierUpgradeModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeTierUpgrade">&times;</span>
    <div class="modal-body"></div>
    <button id="confirmTierUpgrade" class="primary-btn">Upgrade</button>
  </div>
</div>

    
  <!-- Profile Modal -->
  <div id="profileModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h3>Account</h3>
      <button id="logoutBtn" class="logout-btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" 
             viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" 
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 11-4 0v-1m0-10V5a2 2 0 114 0v1"/>
        </svg>
        Logout
      </button>
<!-- PIN Notification Modal -->
<div id="pinNotifyModal" class="modal">
  <div class="modal-content">
    <h3 id="pinNotifyMessage" style="white-space:pre-line; text-align:center;"></h3>
    <button id="pinNotifyClose" class="deposit-btn" 
            style="margin-top:15px; display:flex; align-items:center; justify-content:center; gap:8px;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" 
           stroke="currentColor" width="18" height="18">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M6 18L18 6M6 6l12 12"/>
      </svg>
      Close
    </button>
  </div>
</div>
<script type="module">
  // Import Firebase SDK modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

  document.addEventListener("DOMContentLoaded", async function () {
    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyBcZgyw90RJPAbI2CSp-xdfY8R8T8xNPEQ",
      authDomain: "getting-b1b0a.firebaseapp.com",
      projectId: "getting-b1b0a",
      storageBucket: "getting-b1b0a.firebasestorage.app",
      messagingSenderId: "830283724536",
      appId: "1:830283724536:web:b400eda99ab1e6aad0ed0d"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- Auth State Listener ---
    let currentUser = null;
    let userData = {};
    let unsubscribeUserListener = null;

    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      currentUser = user;
      const userId = user.uid;

     
try {
  const userDocRef = doc(db, "users", userId);
  const docSnap = await getDoc(userDocRef);

  if (docSnap.exists()) {
    userData = docSnap.data();
    console.log("User data loaded:", userData);
  } else {
    const defaultData = {
      balance: 0,
      pendingDeposits: [],
      pendingWithdrawals: [],
      balanceVisible: true,
      currency: "USD",
      tier: 1,
      history: [],
      pin: null,
      paymentMethods: {},
      pinInstructions: "",
      newPinNotification: null,
      createdAt: new Date().toISOString()
    };
    await setDoc(userDocRef, defaultData);
    userData = defaultData;
    console.log("Default user created:", userId);
  }

  // ✅ Start real-time listener
  unsubscribeUserListener = onSnapshot(userDocRef, (snap) => {
    userData = snap.data();
    renderUI(); // ← Update UI on any change
  });

  // ✅ Now render — only after data is loaded
  renderUI();

} catch (error) {
  console.error("Error loading user ", error);
  alert("Failed to load user data. Please try again.");
}
    });

    // --- Helper Functions ---
    function saveUserData() {
      if (!currentUser) return;
      const userId = currentUser.uid;
      const userDocRef = doc(db, "users", userId);
      updateDoc(userDocRef, userData)
        .catch(err => console.error("Save failed:", err));
    }

    function getUserSetting(key, defaultValue) {
      return userData.hasOwnProperty(key) ? userData[key] : defaultValue;
    }

    function setUserSetting(key, value) {
      userData[key] = value;
      saveUserData();
    }

    // --- Currency Symbols & Exchange Rates ---
    const currencySymbols = {
      AED: "د.إ", AFN: "؋", ALL: "L", AMD: "֏", ANG: "ƒ", AOA: "Kz",
      ARS: "$", AUD: "$", AWG: "ƒ", AZN: "₼", BAM: "KM", BBD: "$",
      BDT: "৳", BGN: "лв", BHD: ".د.ب", BIF: "FBu", BMD: "$", BND: "$",
      BOB: "$b", BRL: "R$", BSD: "$", BTN: "Nu.", BWP: "P", BYN: "Br",
      BZD: "$", CAD: "$", CDF: "FC", CHF: "CHF", CLP: "$", CNY: "¥",
      COP: "$", CRC: "₡", CUP: "$", CVE: "$", CZK: "Kč", DJF: "Fdj",
      DKK: "kr", DOP: "$", DZD: "د.ج", EGP: "£", ERN: "Nfk", ETB: "Br",
      EUR: "€", FJD: "$", FKP: "£", GBP: "£", GEL: "₾", GGP: "£",
      GHS: "₵", GIP: "£", GMD: "D", GNF: "FG", GTQ: "Q", GYD: "$",
      HKD: "$", HNL: "L", HRK: "kn", HTG: "G", HUF: "Ft", IDR: "Rp",
      ILS: "₪", IMP: "£", INR: "₹", IQD: "ع.د", IRR: "﷼", ISK: "kr",
      JEP: "£", JMD: "$", JOD: "د.ا", JPY: "¥", KES: "Sh", KGS: "лв",
      KHR: "៛", KMF: "CF", KPW: "₩", KRW: "₩", KWD: "د.ك", KYD: "$",
      KZT: "₸", LAK: "₭", LBP: "ل.ل", LKR: "Rs", LRD: "$", LSL: "L",
      LYD: "ل.د", MAD: "د.م.", MDL: "L", MGA: "Ar", MKD: "ден", MMK: "K",
      MNT: "₮", MOP: "MOP$", MRU: "UM", MUR: "₨", MVR: "Rf", MWK: "MK",
      MXN: "$", MYR: "RM", MZN: "MT", NAD: "$", NGN: "₦", NIO: "C$",
      NOK: "kr", NPR: "₨", NZD: "$", OMR: "ر.ع.", PAB: "B/.", PEN: "S/",
      PGK: "K", PHP: "₱", PKR: "₨", PLN: "zł", PYG: "Gs", QAR: "ر.ق",
      RON: "lei", RSD: "дин.", RUB: "₽", RWF: "FRw", SAR: "ر.س", SBD: "$",
      SCR: "₨", SDG: "ج.س.", SEK: "kr", SGD: "$", SHP: "£", SLL: "Le",
      SOS: "Sh", SPL: "£", SRD: "$", STN: "Db", SVC: "$", SYP: "£",
      SZL: "E", THB: "฿", TJS: "ЅМ", TMT: "m", TND: "د.ت", TOP: "T$",
      TRY: "₺", TTD: "$", TVD: "$", TWD: "NT$", TZS: "Sh", UAH: "₴",
      UGX: "Sh", USD: "$", UYU: "$U", UZS: "лв", VES: "Bs.", VND: "₫",
      VUV: "VT", WST: "T", XAF: "FCFA", XCD: "$", XOF: "CFA", XPF: "₣",
      YER: "﷼", ZAR: "R", ZMW: "ZK", ZWD: "Z$"
    };

    const exchangeRates = {
      AED: 3.67,
      AFN: 86.7,
      ALL: 107.5,
      AMD: 389.0,
      ANG: 1.79,
      AOA: 826.0,
      ARS: 350.0,
      AUD: 1.52,
      AWG: 1.79,
      AZN: 1.7,
      BAM: 1.84,
      BBD: 2.0,
      BDT: 108.0,
      BGN: 1.83,
      BHD: 0.38,
      BIF: 2070,
      BMD: 1.0,
      BND: 1.36,
      BOB: 6.96,
      BRL: 5.43,
      BSD: 1.0,
      BWP: 13.4,
      BYN: 2.57,
      BZD: 2.0,
      CAD: 1.36,
      CHF: 0.92,
      CLP: 817.0,
      CNY: 7.18,
      COP: 5060.0,
      CRC: 535.0,
      CUP: 24.0,
      CZK: 23.5,
      DKK: 6.7,
      DOP: 56.9,
      DZD: 145.0,
      EGP: 30.9,
      ETB: 55.3,
      EUR: 0.93,
      FJD: 2.27,
      GBP: 0.81,
      GEL: 2.53,
      GHS: 11.0,
      GIP: 0.81,
      GNF: 8650,
      GTQ: 7.7,
      HKD: 7.85,
      HNL: 24.6,
      HRK: 7.0,
      HUF: 374.0,
      IDR: 15600,
      ILS: 3.63,
      INR: 83.0,
      IQD: 1460,
      IRR: 42000,
      ISK: 133.0,
      JMD: 156.0,
      JPY: 148.0,
      KES: 148.0,
      KGS: 87.0,
      KHR: 4070,
      KRW: 1360,
      KWD: 0.31,
      KZT: 444.0,
      LAK: 17100,
      LBP: 15100,
      LKR: 324.0,
      LYD: 4.85,
      MAD: 10.4,
      MDL: 19.0,
      MKD: 57.6,
      MMK: 2090,
      MNT: 3400,
      MOP: 8.1,
      MRU: 36.0,
      MUR: 44.0,
      MXN: 18.0,
      MYR: 4.55,
      MZN: 63.0,
      NAD: 18.5,
      NGN: 780.0,
      NOK: 10.4,
      NPR: 131.0,
      NZD: 1.66,
      OMR: 0.39,
      PAB: 1.0,
      PEN: 3.85,
      PGK: 3.65,
      PHP: 55.0,
      PKR: 298.0,
      PLN: 4.3,
      PYG: 7460,
      QAR: 3.64,
      RON: 4.6,
      RSD: 109.0,
      RUB: 92.0,
      RWF: 1250,
      SAR: 3.75,
      SEK: 10.6,
      SGD: 1.36,
      SYP: 2510,
      THB: 35.0,
      TND: 3.0,
      TRY: 32.0,
      UAH: 36.8,
      USD: 1.0,
      UYU: 42.0,
      UZS: 11220,
      VND: 23950,
      XAF: 610.0,
      XOF: 610.0,
      ZAR: 18.0,
      ZMW: 22.0
    };

    // --- Balance Formatting ---
    function formatBalance(amount) {
      const currency = getUserSetting("currency", "USD");
      const rate = exchangeRates[currency] || 1;
      const converted = amount * rate;
      const symbol = currencySymbols[currency] || currency;
      return symbol + converted.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function formatUpgradeCost(amountUSD) {
      const currency = getUserSetting("currency", "USD");
      const rate = exchangeRates[currency] || 1;
      const converted = amountUSD * rate;
      const symbol = currencySymbols[currency] || currency;
      return `${symbol}${converted.toLocaleString(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      })}`;
    }

    // --- Render UI ---
    function renderUI() {
      const username = currentUser.displayName || currentUser.email.split('@')[0];
      document.getElementById("username").textContent = username;
      document.getElementById("profileBadge").textContent = username.charAt(0).toUpperCase();

      renderBalance();
      renderTier();
      renderPaymentMethods();
      renderTransactionHistory();
      checkNewPinNotification();
    }

    function renderBalance() {
      const balance = getUserSetting("balance", 0);
      const visible = getUserSetting("balanceVisible", true);
      const element = document.getElementById("balanceAmount");
      element.textContent = visible ? formatBalance(balance) : "•••••••";
      document.querySelectorAll(".eye-open").forEach(el => el.style.display = visible ? "block" : "none");
      document.querySelectorAll(".eye-slash").forEach(el => el.style.display = visible ? "none" : "block");
    }

    function renderTier() {
      const currentTier = getUserSetting("tier", 1);
      document.querySelectorAll(".tier").forEach(el => {
        const tierLevel = parseInt(el.dataset.tier);
        el.classList.toggle("active", tierLevel === currentTier);
        if (tierLevel < currentTier) el.textContent = `Tier ${tierLevel} ✔`;
        else if (tierLevel > currentTier) el.textContent = `Tier ${tierLevel} 🔒`;
        else el.textContent = `Tier ${tierLevel}`;
      });
    }

    function renderPaymentMethods() {
      const container = document.getElementById("myPaymentMethods");
      if (!container) return;
      container.innerHTML = "";
      const methods = getUserSetting("paymentMethods", {});
      if (Object.keys(methods).length === 0) {
        container.innerHTML = "<em>No saved methods.</em>";
        return;
      }
      Object.entries(methods).forEach(([key, method]) => {
        const div = document.createElement("div");
        div.className = "payment-method";
        const detailsText = typeof method.details === "object"
          ? Object.values(method.details).join(" | ")
          : method.details || "";
        div.innerHTML = `
          <div>
            <strong>${method.type}</strong>
            <div class="meta">${detailsText}</div>
          </div>
          <div class="controls">
            <button class="copy-btn secondary" data-key="${key}">Delete</button>
          </div>
        `;
        div.querySelector('button').addEventListener('click', () => {
          if (confirm("Delete this payment method?")) {
            delete methods[key];
            setUserSetting("paymentMethods", methods);
            renderPaymentMethods();
          }
        });
        container.appendChild(div);
      });
    }
function renderAdminPaymentDetails() {
  const detailsContainer = document.getElementById("adminDetails");
  if (!detailsContainer) return;

  // ✅ Get the actual method + details admin saved
  const method = getUserSetting("paymentMethod", null);
  const details = getUserSetting("paymentDetails", {});

  detailsContainer.innerHTML = "";

  if (!method) {
    detailsContainer.innerHTML = "<em>No payment method set by admin yet.</em>";
    return;
  }

  // Format details object into lines
  const detailsHtml = Object.entries(details)
    .map(([key, value]) => `<div><strong>${key}:</strong> ${value}</div>`)
    .join("");

  detailsContainer.innerHTML = `
    <h4>${method}</h4>
    ${detailsHtml || "<em>No details provided</em>"}
  `;
}

    function renderTransactionHistory() {
      const container = document.getElementById("transactionHistory");
      if (!container) return;
      const history = getUserSetting("history", []);
      const filtered = history.filter(item => !/pin/i.test(item.action.toLowerCase()));
      if (filtered.length === 0) {
        container.innerHTML = "<em>No transactions yet.</em>";
        return;
      }
      container.innerHTML = filtered.map(item => `
        <div style="padding: 8px 0; border-bottom: 1px solid #f3f3fb;">
          <div><strong>${item.action}</strong></div>
          <div style="font-size:13px; color:#555;">${new Date(item.date).toLocaleString()}</div>
        </div>
      `).join('');
    }

    function checkNewPinNotification() {
  const notif = getUserSetting("newPinNotification", null);
  if (!notif || !notif.pin) return;

  // Create modal
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.style.display = "flex";
  modal.innerHTML = `
    <div class="modal-content" style="max-width:400px;text-align:center;position:relative;">
      <span class="close" id="closePinNotify" 
            style="cursor:pointer;position:absolute;top:10px;right:15px;font-size:22px;">&times;</span>
      <h3>Activation PIN</h3>
      <p>Your account activation pin is:</p>
      <p style="font-size:20px;font-weight:bold;color:#7a5cff;">${notif.pin}</p>
      <p style="margin-top:10px;font-size:14px;">Save this information in a safe place and do not share it with anyone.</p>
    </div>`;
  document.body.appendChild(modal);

  // Function to close + clear Firestore value
  const closeModal = () => {
    modal.remove();
    setUserSetting("newPinNotification", null); // clears so it won’t repeat
  };

  // Close on ❌
  modal.querySelector("#closePinNotify").addEventListener("click", closeModal);

  // Close on outside click
  window.addEventListener("click", (e) => {
    if (e.target === modal) closeModal();
  });

  // Close on ESC key
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeModal();
  });
}

    // --- Event Listeners ---
    document.getElementById("toggleBalance")?.addEventListener("click", () => {
      const visible = !getUserSetting("balanceVisible", true);
      setUserSetting("balanceVisible", visible);
      renderBalance();
    });

    document.getElementById("logoutBtn")?.addEventListener("click", async () => {
      await auth.signOut();
      alert("Logged out successfully");
      setTimeout(() => window.location.href = "index.html", 1500);
    });

    // --- Deposit Modal ---
    const plusBtn = document.querySelector(".plus");
    const depositModal = document.getElementById("depositModal");
    const closeDeposit = document.getElementById("closeDeposit");
    const depositFile = document.getElementById("depositFile");
    const chipContainer = document.getElementById("chipContainer");

    plusBtn?.addEventListener("click", () => {
  renderAdminPaymentDetails();   // show admin’s payment info
  depositModal.style.display = "flex";
});

    // === CLOSE MODAL WITH RESET ===
closeDeposit?.addEventListener("click", () => {
  // ✅ 1. Close the modal
  depositModal.style.display = "none";

  // ✅ 2. Reset the upload button text (if using button or label)
  const uploadBtn = document.getElementById("uploadSlipBtn") || 
                    document.getElementById("uploadSlipLabel");

  if (uploadBtn) {
    uploadBtn.innerHTML = "<span>📁 Upload Slip</span>";
    uploadBtn.style.backgroundColor = "";
    uploadBtn.style.color = "";
    uploadBtn.style.fontWeight = "";
  }

  // ✅ 3. Clear the selected file
  depositFile.value = "";

  // ✅ 4. Clear the amount input
  document.getElementById("depositAmount").value = "";

  // ✅ 5. Remove any image previews (optional, but safe)
  document.querySelectorAll(".file-chip.uploaded").forEach(chip => chip.remove());
});

depositFile?.addEventListener("change", () => {
  // ✅ Remove old previews
  document.querySelectorAll(".file-chip.uploaded").forEach(chip => chip.remove());

  const files = Array.from(depositFile.files);
  if (files.length === 0) return;

  // ✅ Update button text to show status
  const uploadBtn = document.getElementById("uploadSlipBtn") || 
                    document.getElementById("uploadSlipLabel");

  if (uploadBtn) {
    uploadBtn.innerHTML = "<span>✅ Slip Attached</span>";
    uploadBtn.style.backgroundColor = "#4caf50";
    uploadBtn.style.color = "white";
    uploadBtn.style.fontWeight = "600";
  }

  // ✅ Create preview chips (optional)
  files.forEach(file => {
    const chip = document.createElement("div");
    chip.className = "file-chip uploaded";

    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);

    const clearBtn = document.createElement("span");
    clearBtn.textContent = "✕";
    clearBtn.className = "chipClear";

    clearBtn.addEventListener("click", () => {
      chip.remove();
      depositFile.value = ""; // clear selection

      // ✅ Restore original button text
      if (uploadBtn) {
        uploadBtn.innerHTML = "<span>📁 Upload Slip</span>";
        uploadBtn.style.backgroundColor = "";
        uploadBtn.style.color = "";
        uploadBtn.style.fontWeight = "";
      }
    });

    chip.appendChild(img);
    chip.appendChild(clearBtn);
    chipContainer.appendChild(chip);
  });
});

document.getElementById("depositForm")?.addEventListener("submit", async e => {
  e.preventDefault();
  const btn = e.target.querySelector("button[type='submit']");
  btn.disabled = true;

  const amountInput = document.getElementById("depositAmount");
  const amount = parseFloat(amountInput.value);
  const files = depositFile.files;

  // --- Validation ---
  if (!files || files.length === 0) {
    showNotification("Please upload a slip.");
    btn.disabled = false;
    return;
  }

  if (isNaN(amount) || amount <= 0) {
    showNotification("Invalid amount.");
    btn.disabled = false;
    return;
  }

  const file = files[0];
  if (!file.type.startsWith("image/")) {
    showNotification("Invalid file type. Please upload an image.");
    btn.disabled = false;
    return;
  }

  // --- Save Deposit Request ---
  const slipUrl = URL.createObjectURL(file);
  const currency = getUserSetting("currency", "USD");

  const request = {
    amount,
    currency,
    status: "pending",
    date: new Date().toISOString(),
    slipName: file.name,
    slipType: file.type,
    slipSize: file.size,
    slipUrl,
    type: "deposit"
  };

  const pendingDeposits = getUserSetting("pendingDeposits", []);
  pendingDeposits.push(request);
  setUserSetting("pendingDeposits", pendingDeposits);

  const history = getUserSetting("history", []);
  history.unshift({
    action: `Deposit submitted ${amount.toFixed(2)} ${currency}`,
    date: new Date().toISOString()
  });
  setUserSetting("history", history);

  // --- ✅ SAFE RESET: Do NOT delete the upload label! ---
  // Clear only preview chips (not the "Upload Slip" label)
  document.querySelectorAll(".file-chip.uploaded").forEach(chip => chip.remove());

  // Ensure "Upload Slip" label still exists
  if (!document.getElementById("uploadSlipLabel")) {
    const label = document.createElement("label");
    label.htmlFor = "depositFile";
    label.className = "file-chip upload-trigger";
    label.id = "uploadSlipLabel";
    label.innerHTML = "<span>📁 Upload Slip</span>";
    chipContainer.appendChild(label);
  }

  // Reset form fields
  amountInput.value = "";
  depositFile.value = ""; // clear selected files

  // Close modal
  depositModal.style.display = "none";

  // Show success
  showNotification("Deposit submitted. Awaiting confirmation.");

  // Re-enable button
  btn.disabled = false;
});

    // --- Manage Payment Methods ---
    const addPaymentAction = document.querySelector(".actions .action:nth-child(3)");
    const managePaymentModal = document.getElementById("managePaymentModal");
    const closeManagePayment = document.getElementById("closeManagePayment");
    const addPaymentForm = document.getElementById("addPaymentForm");
    const pmType = document.getElementById("pmType");
    const pmDynamicFields = document.getElementById("pmDynamicFields");
    const pmLabel = document.getElementById("pmLabel");
    const cancelAddPayment = document.getElementById("cancelAddPayment");

    function renderDynamicFields(type, existing = {}) {
      pmDynamicFields.innerHTML = "";
      function makeInput(id, placeholder, value = "") {
        const input = document.createElement("input");
        input.id = id;
        input.type = "text";
        input.placeholder = placeholder;
        input.value = value;
        input.required = true;
        input.style.marginBottom = "8px";
        pmDynamicFields.appendChild(input);
        return input;
      }

      if (type === "GCash") {
        makeInput("gcashName", "Account Name", existing.gcashName || "");
        makeInput("gcashNumber", "Account Number", existing.gcashNumber || "");
      } else if (type === "Bank") {
        makeInput("bankName", "Bank Name", existing.bankName || "");
        makeInput("accountName", "Account Name", existing.accountName || "");
        makeInput("accountNumber", "Account Number", existing.accountNumber || "");
      } else if (type === "CashApp") {
        makeInput("cashappTag", "Cash App Tag ($username)", existing.cashappTag || "");
      } else if (type === "PayPal") {
        makeInput("paypalUser", "PayPal Email", existing.paypalUser || "");
      } else if (type === "Wallet") {
        makeInput("walletAddr", "Wallet Address", existing.walletAddr || "");
      } else if (type === "Other") {
        makeInput("otherDetails", "Details", existing.otherDetails || "");
      }
    }

    pmType?.addEventListener("change", () => {
      renderDynamicFields(pmType.value);
    });

    addPaymentAction?.addEventListener("click", () => {
      managePaymentModal.style.display = "flex";
      pmType.value = "";
      pmDynamicFields.innerHTML = "";
      pmLabel.textContent = "Add New Method";
    });

    closeManagePayment?.addEventListener("click", () => managePaymentModal.style.display = "none");
    cancelAddPayment?.addEventListener("click", () => {
      addPaymentForm.reset();
      delete addPaymentForm.dataset.editKey;
    });

    addPaymentForm?.addEventListener("submit", e => {
      e.preventDefault();
      const type = pmType.value;
      const label = (pmLabel.value || type).trim();
      let details = {};

      if (!type) {
        showNotification("Please select a method type.");
        return;
      }

      if (type === "GCash") {
        const name = document.getElementById("gcashName").value.trim();
        const number = document.getElementById("gcashNumber").value.trim();
        if (!name || !number) {
          showNotification("Please fill all fields.");
          return;
        }
        details = { Name: name, Number: number };
      } else if (type === "Bank") {
        const bank = document.getElementById("bankName").value.trim();
        const name = document.getElementById("accountName").value.trim();
        const number = document.getElementById("accountNumber").value.trim();
        if (!bank || !name || !number) {
          showNotification("Please fill all fields.");
          return;
        }
        details = { Bank: bank, Name: name, Number: number };
      } else if (type === "CashApp") {
        const tag = document.getElementById("cashappTag").value.trim();
        if (!tag) {
          showNotification("Please enter Cash App tag.");
          return;
        }
        details = { Tag: tag };
      } else if (type === "PayPal") {
        const user = document.getElementById("paypalUser").value.trim();
        if (!user) {
          showNotification("Please enter PayPal email.");
          return;
        }
        details = { User: user };
      } else if (type === "Wallet") {
        const addr = document.getElementById("walletAddr").value.trim();
        if (!addr) {
          showNotification("Please enter wallet address.");
          return;
        }
        details = { Address: addr };
      } else if (type === "Other") {
        const desc = document.getElementById("otherDetails").value.trim();
        if (!desc) {
          showNotification("Please describe the method.");
          return;
        }
        details = { Description: desc };
      }

      const key = `${label.replace(/\s+/g, "_").toLowerCase()}_${Date.now()}`;
      const methods = getUserSetting("paymentMethods", {});
      if (addPaymentForm.dataset.editKey) {
        const k = addPaymentForm.dataset.editKey;
        methods[k] = { type, label, details };
        delete addPaymentForm.dataset.editKey;
      } else {
        methods[key] = { type, label, details };
      }

      setUserSetting("paymentMethods", methods);
      renderPaymentMethods();
      renderPaymentMethods(); // refresh everywhere
      showNotification("Payment method saved.");
      addPaymentForm.reset();
      pmDynamicFields.innerHTML = "";
      managePaymentModal.style.display = "none";
    });

    // --- Withdraw Modal ---
    const withdrawAction = document.querySelector(".actions .action:first-child");
    const withdrawModal = document.getElementById("withdrawModal");
    const closeWithdraw = document.getElementById("closeWithdraw");
    const editPaymentBtn = document.getElementById("editPaymentBtn");

    function renderWithdrawMethodDisplay() {
      const container = document.getElementById("withdrawMethodDisplay");
      if (!container) return null;
      const methods = getUserSetting("paymentMethods", {});
      const keys = Object.keys(methods);
      if (keys.length === 0) {
        container.innerHTML = "<em>No payment method set.</em>";
        return null;
      }
      const key = keys[keys.length - 1];
      const method = methods[key];
      const details = typeof method.details === "object"
        ? Object.values(method.details).join(" | ")
        : method.details || "";
      container.innerHTML = `
        <strong>${method.label || method.type}</strong><br>
        <span style="font-size:13px;color:#444;">${method.type} · ${details}</span>
      `;
      return key;
    }

    withdrawAction?.addEventListener("click", () => {
      renderWithdrawMethodDisplay();
      withdrawModal.style.display = "flex";
    });

    closeWithdraw?.addEventListener("click", () => withdrawModal.style.display = "none");
    window.addEventListener("click", e => { if (e.target === withdrawModal) withdrawModal.style.display = "none"; });

    editPaymentBtn?.addEventListener("click", () => {
      withdrawModal.style.display = "none";
      managePaymentModal.style.display = "flex";
    });

    document.getElementById("withdrawForm")?.addEventListener("submit", e => {
      e.preventDefault();
      const amount = parseFloat(document.getElementById("withdrawAmount").value);
      const currency = getUserSetting("currency", "USD");
      const baseRate = exchangeRates[currency] || 1;
      const amountInBase = amount / baseRate;

      if (isNaN(amount) || amount < 20) {
        showNotification(`Minimum withdrawal is ${currencySymbols[currency]}20`);
        return;
      }

      const methodKey = renderWithdrawMethodDisplay();
      if (!methodKey) {
        showNotification("Please add a payment method first.");
        return;
      }

      if (amountInBase > getUserSetting("balance", 0)) {
        showNotification("Insufficient funds.");
        return;
      }

      withdrawModal.style.display = "none";
      document.getElementById("pinModal").style.display = "flex";
      document.getElementById("pinModal").dataset.amount = amountInBase;
      document.getElementById("pinModal").dataset.currency = currency;
    });

    // --- PIN Modal ---
    const pinModal = document.getElementById("pinModal");
    const closePin = pinModal.querySelector(".close");

    document.getElementById("pinForm")?.addEventListener("submit", e => {
      e.preventDefault();
      const enteredPin = document.getElementById("activationPin").value.trim();
      const amount = parseFloat(pinModal.dataset.amount);
      const currency = pinModal.dataset.currency;

      if (enteredPin !== getUserSetting("pin", "")) {
        showNotification("Invalid PIN.");
        return;
      }

      const pendingWithdrawals = getUserSetting("pendingWithdrawals", []);
      pendingWithdrawals.push({
        amount,
        originalAmount: amount * (exchangeRates[currency] || 1),
        currency,
        status: "pending",
        date: new Date().toISOString()
      });
      setUserSetting("pendingWithdrawals", pendingWithdrawals);

      const history = getUserSetting("history", []);
      history.unshift({
        action: `Withdrawal requested ${amount.toFixed(2)} ${currency}`,
        date: new Date().toISOString()
      });
      setUserSetting("history", history);

      showNotification(`Withdrawal of ${amount.toFixed(2)} ${currency} submitted.`);
      pinModal.style.display = "none";
      e.target.reset();
    });

    closePin?.addEventListener("click", () => pinModal.style.display = "none");
    window.addEventListener("click", e => { if (e.target === pinModal) pinModal.style.display = "none"; });

    // --- Buy PIN Modal ---
    const buyPinBtn = document.getElementById("buyPinBtn");
    buyPinBtn?.addEventListener("click", () => {
      const notifyModal = document.getElementById("notifyModal");
      const notifyMessage = document.getElementById("notifyMessage");
      const notifyClose = document.getElementById("notifyClose");
      notifyMessage.innerHTML = `
        <p style="font-size:15px; margin-bottom:12px; text-align:center;">
          Please contact your project manager to purchase a PIN.
        </p>
        <button id="buyHereBtn" style="
          margin-top:10px;background:#27ae60;color:#fff;font-weight:600;
          padding:10px 14px;border:none;border-radius:6px;display:flex;
          align-items:center;justify-content:center;gap:8px;width:100%;cursor:pointer;">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" 
               fill="none" stroke="currentColor" stroke-width="2" 
               stroke-linecap="round" stroke-linejoin="round" 
               class="feather feather-credit-card">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
            <line x1="1" y1="10" x2="23" y2="10"></line>
          </svg>
          Buy Here
        </button>
      `;
      notifyModal.style.display = "flex";
      notifyClose.onclick = () => notifyModal.style.display = "none";

      setTimeout(() => {
        const buyHereBtn = document.getElementById("buyHereBtn");
        if (buyHereBtn) {
          buyHereBtn.addEventListener("click", () => {
            notifyModal.style.display = "none";
            document.getElementById("pinBuyModal").style.display = "flex";
            renderPaymentMethods();
          });
        }
      }, 50);
    });

    // --- Pin Buy Form ---
    const pinBuyModal = document.getElementById("pinBuyModal");
    const closePinBuy = document.getElementById("closePinBuy");
    const pinBuyFile = document.getElementById("pinBuyFile");
    const pinBuyChipContainer = document.getElementById("pinBuyChipContainer");

    closePinBuy?.addEventListener("click", () => pinBuyModal.style.display = "none");
    window.addEventListener("click", e => { if (e.target === pinBuyModal) pinBuyModal.style.display = "none"; });

    pinBuyFile?.addEventListener("change", () => {
      pinBuyChipContainer.querySelectorAll(".file-chip.uploaded").forEach(chip => chip.remove());
      Array.from(pinBuyFile.files).forEach(file => {
        const chip = document.createElement("div");
        chip.className = "file-chip uploaded";
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        const clearBtn = document.createElement("span");
        clearBtn.textContent = "✕";
        clearBtn.className = "chipClear";
        clearBtn.addEventListener("click", () => {
          chip.remove();
          const dt = new DataTransfer();
          Array.from(pinBuyFile.files).forEach(f => { if (f !== file) dt.items.add(f); });
          pinBuyFile.files = dt.files;
        });
        chip.appendChild(img);
        chip.appendChild(clearBtn);
        pinBuyChipContainer.appendChild(chip);
      });
    });

    document.getElementById("pinBuyForm")?.addEventListener("submit", e => {
      e.preventDefault();
      const files = pinBuyFile.files;
      if (!files || files.length === 0) {
        showNotification("Please upload a payment slip.");
        return;
      }
      const file = files[0];
      if (!file.type.startsWith("image/")) {
        showNotification("Invalid file type. Please upload an image.");
        return;
      }
      const slipUrl = URL.createObjectURL(file);
      const pendingDeposits = getUserSetting("pendingDeposits", []);
      pendingDeposits.push({
        status: "pending",
        date: new Date().toISOString(),
        slipName: file.name,
        slipType: file.type,
        slipSize: file.size,
        slipUrl,
        type: "pin"
      });
      setUserSetting("pendingDeposits", pendingDeposits);

      const history = getUserSetting("history", []);
      history.unshift({ action: "PIN request submitted", date: new Date().toISOString() });
      setUserSetting("history", history);

      showNotification("PIN request submitted. Awaiting confirmation.");
      pinBuyModal.style.display = "none";
      e.target.reset();
      pinBuyChipContainer.innerHTML = "";
      pinBuyFile.value = null;
    });

    // --- Currency Modal ---
    const changeCurrencyAction = document.querySelector(".actions .action:nth-child(2)");
    const currencyModal = document.getElementById("currencyModal");
    const closeCurrency = document.getElementById("closeCurrency");
    const currencyList = document.getElementById("currencyList");
    const currencySearch = document.getElementById("currencySearch");

    const availableCurrencies = [
      { code: "AED", symbol: "د.إ", name: "United Arab Emirates Dirham", flag: "🇦🇪" },
      { code: "AFN", symbol: "؋", name: "Afghan Afghani", flag: "🇦🇫" },
      { code: "ALL", symbol: "L", name: "Albanian Lek", flag: "🇦🇱" },
      { code: "AMD", symbol: "֏", name: "Armenian Dram", flag: "🇦🇲" },
      { code: "ANG", symbol: "ƒ", name: "Netherlands Antillean Guilder", flag: "🇳🇱" },
      { code: "AOA", symbol: "Kz", name: "Angolan Kwanza", flag: "🇦🇴" },
      { code: "ARS", symbol: "$", name: "Argentine Peso", flag: "🇦🇷" },
      { code: "AUD", symbol: "$", name: "Australian Dollar", flag: "🇦🇺" },
      { code: "AWG", symbol: "ƒ", name: "Aruban Florin", flag: "🇦🇼" },
      { code: "AZN", symbol: "₼", name: "Azerbaijani Manat", flag: "🇦🇿" },
      { code: "BAM", symbol: "KM", name: "Bosnia-Herzegovina Convertible Mark", flag: "🇧🇦" },
      { code: "BBD", symbol: "$", name: "Barbadian Dollar", flag: "🇧🇧" },
      { code: "BDT", symbol: "৳", name: "Bangladeshi Taka", flag: "🇧🇩" },
      { code: "BGN", symbol: "лв", name: "Bulgarian Lev", flag: "🇧🇬" },
      { code: "BHD", symbol: ".د.ب", name: "Bahraini Dinar", flag: "🇧🇭" },
      { code: "BIF", symbol: "FBu", name: "Burundian Franc", flag: "🇧🇮" },
      { code: "BMD", symbol: "$", name: "Bermudian Dollar", flag: "🇧🇲" },
      { code: "BND", symbol: "$", name: "Brunei Dollar", flag: "🇧🇳" },
      { code: "BOB", symbol: "Bs", name: "Bolivian Boliviano", flag: "🇧🇴" },
      { code: "BRL", symbol: "R$", name: "Brazilian Real", flag: "🇧🇷" },
      { code: "BSD", symbol: "$", name: "Bahamian Dollar", flag: "🇧🇸" },
      { code: "BWP", symbol: "P", name: "Botswana Pula", flag: "🇧🇼" },
      { code: "BYN", symbol: "Br", name: "Belarusian Ruble", flag: "🇧🇾" },
      { code: "BZD", symbol: "$", name: "Belize Dollar", flag: "🇧🇿" },
      { code: "CAD", symbol: "$", name: "Canadian Dollar", flag: "🇨🇦" },
      { code: "CHF", symbol: "CHF", name: "Swiss Franc", flag: "🇨🇭" },
      { code: "CLP", symbol: "$", name: "Chilean Peso", flag: "🇨🇱" },
      { code: "CNY", symbol: "¥", name: "Chinese Yuan", flag: "🇨🇳" },
      { code: "COP", symbol: "$", name: "Colombian Peso", flag: "🇨🇴" },
      { code: "CRC", symbol: "₡", name: "Costa Rican Colón", flag: "🇨🇷" },
      { code: "CUP", symbol: "$", name: "Cuban Peso", flag: "🇨🇺" },
      { code: "CZK", symbol: "Kč", name: "Czech Koruna", flag: "🇨🇿" },
      { code: "DKK", symbol: "kr", name: "Danish Krone", flag: "🇩🇰" },
      { code: "DOP", symbol: "$", name: "Dominican Peso", flag: "🇩🇴" },
      { code: "DZD", symbol: "د.ج", name: "Algerian Dinar", flag: "🇩🇿" },
      { code: "EGP", symbol: "£", name: "Egyptian Pound", flag: "🇪🇬" },
      { code: "ETB", symbol: "Br", name: "Ethiopian Birr", flag: "🇪🇹" },
      { code: "EUR", symbol: "€", name: "Euro", flag: "🇪🇺" },
      { code: "FJD", symbol: "$", name: "Fijian Dollar", flag: "🇫🇯" },
      { code: "GBP", symbol: "£", name: "British Pound Sterling", flag: "🇬🇧" },
      { code: "GEL", symbol: "₾", name: "Georgian Lari", flag: "🇬🇪" },
      { code: "GHS", symbol: "₵", name: "Ghanaian Cedi", flag: "🇬🇭" },
      { code: "GIP", symbol: "£", name: "Gibraltar Pound", flag: "🇬🇮" },
      { code: "GNF", symbol: "FG", name: "Guinean Franc", flag: "🇬🇳" },
      { code: "GTQ", symbol: "Q", name: "Guatemalan Quetzal", flag: "🇬🇹" },
      { code: "HKD", symbol: "$", name: "Hong Kong Dollar", flag: "🇭🇰" },
      { code: "HNL", symbol: "L", name: "Honduran Lempira", flag: "🇭🇳" },
      { code: "HRK", symbol: "kn", name: "Croatian Kuna", flag: "🇭🇷" },
      { code: "HUF", symbol: "Ft", name: "Hungarian Forint", flag: "🇭🇺" },
      { code: "IDR", symbol: "Rp", name: "Indonesian Rupiah", flag: "🇮🇩" },
      { code: "ILS", symbol: "₪", name: "Israeli New Shekel", flag: "🇮🇱" },
      { code: "INR", symbol: "₹", name: "Indian Rupee", flag: "🇮🇳" },
      { code: "IQD", symbol: "ع.د", name: "Iraqi Dinar", flag: "🇮🇶" },
      { code: "IRR", symbol: "﷼", name: "Iranian Rial", flag: "🇮🇷" },
      { code: "ISK", symbol: "kr", name: "Icelandic Króna", flag: "🇮🇸" },
      { code: "JMD", symbol: "$", name: "Jamaican Dollar", flag: "🇯🇲" },
      { code: "JPY", symbol: "¥", name: "Japanese Yen", flag: "🇯🇵" },
      { code: "KES", symbol: "Sh", name: "Kenyan Shilling", flag: "🇰🇪" },
      { code: "KGS", symbol: "лв", name: "Kyrgyzstani Som", flag: "🇰🇬" },
      { code: "KHR", symbol: "៛", name: "Cambodian Riel", flag: "🇰🇭" },
      { code: "KRW", symbol: "₩", name: "South Korean Won", flag: "🇰🇷" },
      { code: "KWD", symbol: "د.ك", name: "Kuwaiti Dinar", flag: "🇰🇼" },
      { code: "KZT", symbol: "₸", name: "Kazakhstani Tenge", flag: "🇰🇿" },
      { code: "LAK", symbol: "₭", name: "Lao Kip", flag: "🇱🇦" },
      { code: "LBP", symbol: "ل.ل", name: "Lebanese Pound", flag: "🇱🇧" },
      { code: "LKR", symbol: "Rs", name: "Sri Lankan Rupee", flag: "🇱🇰" },
      { code: "LYD", symbol: "ل.د", name: "Libyan Dinar", flag: "🇱🇾" },
      { code: "MAD", symbol: "د.م.", name: "Moroccan Dirham", flag: "🇲🇦" },
      { code: "MDL", symbol: "L", name: "Moldovan Leu", flag: "🇲🇩" },
      { code: "MKD", symbol: "ден", name: "Macedonian Denar", flag: "🇲🇰" },
      { code: "MMK", symbol: "K", name: "Myanmar Kyat", flag: "🇲🇲" },
      { code: "MNT", symbol: "₮", name: "Mongolian Tögrög", flag: "🇲🇳" },
      { code: "MOP", symbol: "MOP$", name: "Macanese Pataca", flag: "🇲🇴" },
      { code: "MRU", symbol: "UM", name: "Mauritanian Ouguiya", flag: "🇲🇷" },
      { code: "MUR", symbol: "₨", name: "Mauritian Rupee", flag: "🇲🇺" },
      { code: "MXN", symbol: "$", name: "Mexican Peso", flag: "🇲🇽" },
      { code: "MYR", symbol: "RM", name: "Malaysian Ringgit", flag: "🇲🇾" },
      { code: "MZN", symbol: "MT", name: "Mozambican Metical", flag: "🇲🇿" },
      { code: "NAD", symbol: "$", name: "Namibian Dollar", flag: "🇳🇦" },
      { code: "NGN", symbol: "₦", name: "Nigerian Naira", flag: "🇳🇬" },
      { code: "NOK", symbol: "kr", name: "Norwegian Krone", flag: "🇳🇴" },
      { code: "NPR", symbol: "₨", name: "Nepalese Rupee", flag: "🇳🇵" },
      { code: "NZD", symbol: "$", name: "New Zealand Dollar", flag: "🇳🇿" },
      { code: "OMR", symbol: "ر.ع.", name: "Omani Rial", flag: "🇴🇲" },
      { code: "PAB", symbol: "B/.", name: "Panamanian Balboa", flag: "🇵🇦" },
      { code: "PEN", symbol: "S/", name: "Peruvian Sol", flag: "🇵🇪" },
      { code: "PGK", symbol: "K", name: "Papua New Guinean Kina", flag: "🇵🇬" },
      { code: "PHP", symbol: "₱", name: "Philippine Peso", flag: "🇵🇭" },
      { code: "PKR", symbol: "₨", name: "Pakistani Rupee", flag: "🇵🇰" },
      { code: "PLN", symbol: "zł", name: "Polish Zloty", flag: "🇵🇱" },
      { code: "PYG", symbol: "₲", name: "Paraguayan Guaraní", flag: "🇵🇾" },
      { code: "QAR", symbol: "ر.ق", name: "Qatari Riyal", flag: "🇶🇦" },
      { code: "RON", symbol: "lei", name: "Romanian Leu", flag: "🇷🇴" },
      { code: "RSD", symbol: "дин", name: "Serbian Dinar", flag: "🇷🇸" },
      { code: "RUB", symbol: "₽", name: "Russian Ruble", flag: "🇷🇺" },
      { code: "RWF", symbol: "FRw", name: "Rwandan Franc", flag: "🇷🇼" },
      { code: "SAR", symbol: "ر.س", name: "Saudi Riyal", flag: "🇸🇦" },
      { code: "SEK", symbol: "kr", name: "Swedish Krona", flag: "🇸🇪" },
      { code: "SGD", symbol: "$", name: "Singapore Dollar", flag: "🇸🇬" },
      { code: "SYP", symbol: "£", name: "Syrian Pound", flag: "🇸🇾" },
      { code: "THB", symbol: "฿", name: "Thai Baht", flag: "🇹🇭" },
      { code: "TND", symbol: "د.ت", name: "Tunisian Dinar", flag: "🇹🇳" },
      { code: "TRY", symbol: "₺", name: "Turkish Lira", flag: "🇹🇷" },
      { code: "UAH", symbol: "₴", name: "Ukrainian Hryvnia", flag: "🇺🇦" },
      { code: "USD", symbol: "$", name: "United States Dollar", flag: "🇺🇸" },
      { code: "UYU", symbol: "$U", name: "Uruguayan Peso", flag: "🇺🇾" },
      { code: "UZS", symbol: "лв", name: "Uzbekistani Som", flag: "🇺🇿" },
      { code: "VND", symbol: "₫", name: "Vietnamese Dong", flag: "🇻🇳" },
      { code: "XAF", symbol: "FCFA", name: "Central African CFA Franc", flag: "🇨🇲" },
      { code: "XOF", symbol: "CFA", name: "West African CFA Franc", flag: "🇸🇳" },
      { code: "ZAR", symbol: "R", name: "South African Rand", flag: "🇿🇦" },
      { code: "ZMW", symbol: "ZK", name: "Zambian Kwacha", flag: "🇿🇲" }
    ];

    function renderCurrencyList(filter = "") {
      currencyList.innerHTML = "";
      const filtered = availableCurrencies.filter(c =>
        c.code.toLowerCase().includes(filter.toLowerCase()) ||
        c.name.toLowerCase().includes(filter.toLowerCase())
      );
      if (filtered.length === 0) {
        currencyList.innerHTML = '<div style="padding:12px;color:#666">No currencies found.</div>';
        return;
      }
      const currentCurrency = getUserSetting("currency", "EUR");
      filtered.forEach(c => {
        const item = document.createElement("div");
        item.className = "currency-item";
        item.style.padding = "10px 12px";
        item.style.borderBottom = "1px solid #f3f3fb";
        item.style.cursor = "pointer";
        item.style.display = "flex";
        item.style.alignItems = "center";
        if (c.code === currentCurrency) {
          item.style.background = "#e9e6ff";
          item.style.fontWeight = "600";
        }
        item.innerHTML = `<span style="font-size:20px; margin-right:8px;">${c.flag}</span> <strong>${c.code}</strong> <span style="color:#666; margin-left:6px;">${c.name}</span>`;
        item.addEventListener("click", () => {
          setUserSetting("currency", c.code);
          renderBalance();
          currencyModal.style.display = "none";
          showNotification(`Currency changed to ${c.flag} ${c.code}`);
        });
        currencyList.appendChild(item);
      });
    }

    changeCurrencyAction?.addEventListener("click", () => {
      renderCurrencyList();
      currencySearch.value = "";
      currencyModal.style.display = "flex";
      setTimeout(() => currencySearch.focus(), 50);
    });

    closeCurrency?.addEventListener("click", () => currencyModal.style.display = "none");
    window.addEventListener("click", e => { if (e.target === currencyModal) currencyModal.style.display = "none"; });
    currencySearch?.addEventListener("input", () => renderCurrencyList(currencySearch.value));
    window.addEventListener("keydown", (e) => { if (e.key === "Escape") currencyModal.style.display = "none"; });

    // --- Tier Upgrade System ---
    document.querySelectorAll(".tier").forEach((el) => {
      el.addEventListener("click", () => {
        const selectedTier = parseInt(el.dataset.tier);
        const currentTier = getUserSetting("tier", 1);
        if (selectedTier <= currentTier) {
          showNotification(`✅ You’re already on Tier ${currentTier}.`);
        } else if (selectedTier === currentTier + 1) {
          const modal = document.getElementById("tierUpgradeModal");
          const modalBody = modal.querySelector(".modal-body");
          if (selectedTier === 2) {
            modalBody.innerHTML = `
              <h3>Upgrade to Tier 2</h3>
              <div style="text-align:center; margin:10px 0;">
                <svg xmlns="http://www.w3.org/2000/svg" width="70" height="70" fill="none" stroke="green" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="2" y="6" width="20" height="12" rx="2" ry="2"></rect>
                  <path d="M6 12h12"></path>
                  <circle cx="12" cy="12" r="3"></circle>
                </svg>
              </div>
              <ul style="list-style:none; padding:0; text-align:left;">
                <li style="display:flex; align-items:center; gap:6px; margin:6px 0;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="green" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M1 10h22"></path>
                  </svg>
                  Increase transaction limit
                </li>
                <li style="display:flex; align-items:center; gap:6px; margin:6px 0;">
                  <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" stroke="orange" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="7" cy="7" r="3"></circle>
                    <path d="M10 7h10v4h-4v4h-4v-4h-2"></path>
                  </svg>
                  Use activation PIN up to 6 times
                </li>
              </ul>
              <p style="color:green;font-weight:bold;">Upgrade cost: ${formatUpgradeCost(100)}</p>
            `;
          } else if (selectedTier === 3) {
            modalBody.innerHTML = `
              <h3>Upgrade to Tier 3</h3>
              <ul>
                <li>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="#8A2BE2" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M12 2l3 7h7l-5.5 4.5 2 7L12 16l-6.5 4-2-7L1 9h7l3-7z"/>
                  </svg>
                  Highest transaction limits
                </li>
                <li>
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="#FFA500" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M3 12l18-12v24L3 12z"/>
                  </svg>
                  Priority withdrawals
                </li>
                <li>
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="#008000" style="vertical-align: middle; margin-right: 5px;">
                    <path d="M12 1L3 5v6c0 5.5 3.8 10.74 9 12 5.2-1.26 9-6.5 9-12V5l-9-4z"/>
                  </svg>
                  Premium security features
                </li>
              </ul>
              <p style="color:green;font-weight:bold;">Upgrade cost: ${formatUpgradeCost(500)}</p>
            `;
          }
          modal.dataset.tier = selectedTier;
          modal.style.display = "flex";
        } else {
          showNotification("🔒 This tier is locked. Upgrade step by step!");
        }
      });
    });

    // --- Confirm Tier Upgrade ---
    const tierUpgradeModal = document.getElementById("tierUpgradeModal");
    const closeTierUpgrade = document.getElementById("closeTierUpgrade");
    const confirmTierUpgrade = document.getElementById("confirmTierUpgrade");

    closeTierUpgrade?.addEventListener("click", () => tierUpgradeModal.style.display = "none");
    confirmTierUpgrade?.addEventListener("click", () => {
      const selectedTier = parseInt(tierUpgradeModal.dataset.tier || "0");
      tierUpgradeModal.style.display = "none";
      depositModal.style.display = "flex";
      const depositInput = document.getElementById("depositAmount");
      if (depositInput) {
        const rate = exchangeRates[getUserSetting("currency", "USD")] || 1;
        depositInput.value = (selectedTier === 2 ? 100 : 500) * rate;
      }
      showNotification(`💳 Please deposit to unlock Tier ${selectedTier}.`);
    });

    // --- History Modal ---
    const historyBtn = document.querySelector(".actions .action:nth-child(4)");
    const historyModal = document.getElementById("historyModal");
    const closeHistory = document.getElementById("closeHistory");

    historyBtn?.addEventListener("click", () => {
      renderTransactionHistory();
      historyModal.style.display = "flex";
    });
    closeHistory?.addEventListener("click", () => historyModal.style.display = "none");
    window.addEventListener("click", e => { if (e.target === historyModal) historyModal.style.display = "none"; });

    // --- Notification Function ---
    function showNotification(message) {
      const notifyModal = document.getElementById("notifyModal");
      const notifyMessage = document.getElementById("notifyMessage");
      const notifyClose = document.getElementById("notifyClose");
      notifyMessage.textContent = message;
      notifyModal.style.display = "flex";
      notifyClose.onclick = () => notifyModal.style.display = "none";
      setTimeout(() => { notifyModal.style.display = "none"; }, 3000);
    }

    // --- Greeting ---
    const hour = new Date().getHours();
    document.getElementById("timeGreeting").textContent =
      hour < 12 ? "Good Morning" : hour < 18 ? "Good Afternoon" : "Good Evening";

    // --- Profile Modal & Logout ---
    const profileBadge = document.getElementById("profileBadge");
    const profileModal = document.getElementById("profileModal");
    const closeProfile = document.querySelector("#profileModal .close");
    const logoutBtn = document.getElementById("logoutBtn");

    profileBadge?.addEventListener("click", () => profileModal.style.display = "flex");
    closeProfile?.addEventListener("click", () => profileModal.style.display = "none");
    window.addEventListener("click", e => { if (e.target === profileModal) profileModal.style.display = "none"; });
    logoutBtn?.addEventListener("click", async () => {
      await auth.signOut();
      showNotification("Logged out successfully");
      setTimeout(() => { window.location.href = "index.html"; }, 1500);
    });

    // --- Tips Rotation ---
    const tips = [
      "💳 Set up a payment method for faster withdrawals.",
      "🔐 Never share your activation PIN with anyone.",
      "📊 Track your deposits and withdrawals regularly.",
      "🌍 Switch currency for easier international transfers.",
      "💡 Keep your balance private when sharing your screen."
    ];
    const tipsParagraph = document.querySelector(".tips p");
    const tipsBulb = document.querySelector(".tips h3 svg");
    let currentTipIndex = 0;

    function showNextTip() {
      tipsParagraph.style.opacity = 0;
      setTimeout(() => {
        tipsParagraph.textContent = tips[currentTipIndex];
        tipsParagraph.style.opacity = 1;
        tipsBulb.classList.remove("glow");
        void tipsBulb.offsetWidth;
        tipsBulb.classList.add("glow");
        currentTipIndex = (currentTipIndex + 1) % tips.length;
      }, 600);
    }

    showNextTip();
    setInterval(showNextTip, 7000);

    // --- Initial Load ---
    renderUI();
  });
</script>
</body>
</html>
