<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login & Signup (Firebase Authentication)</title>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:#f7f7f8; margin:0; display:flex; align-items:center; justify-content:center; height:100vh; }
    .box { background:#fff; padding:24px; border-radius:12px; width:320px; box-shadow:0 6px 20px rgba(0,0,0,0.08); }
    h2 { margin:0 0 12px; color:#7a5cff; text-align:center; }
    input { width:100%; padding:10px 12px; margin:8px 0; border:1px solid #ddd; border-radius:8px; font-size:15px; box-sizing:border-box; }
    button { width:100%; padding:10px; margin-top:8px; border-radius:8px; border:none; background:#7a5cff; color:#fff; font-weight:700; cursor:pointer; }
    .small { font-size:13px; color:#666; text-align:center; margin-top:10px; }
    .demo { background:#27ae60; margin-top:10px; }
    .note { font-size:12px; color:#555; margin-top:6px; background:#f1f1f1; padding:8px; border-radius:6px;}
    .error { color: crimson; font-size: 14px; text-align: center; margin-top: 10px; }
    .success { color: #27ae60; font-size: 14px; text-align: center; margin-top: 10px; }
    .loading { display: none; text-align: center; margin-top: 10px; }
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #7a5cff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* Enhanced signup form styles */
    .signup-form {
      display: none;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .form-toggle {
      background: transparent;
      border: none;
      color: #7a5cff;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      padding: 0;
      margin: 5px 0;
    }
    .form-toggle:hover {
      color: #5a40d9;
    }
    .password-strength {
      margin-top: 5px;
      font-size: 12px;
      height: 10px;
    }
    .strength-bar {
      height: 4px;
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 2px;
      margin-top: 5px;
      overflow: hidden;
    }
    .strength-fill {
      height: 100%;
      width: 0%;
      transition: width 0.3s ease, background-color 0.3s ease;
    }
    .strength-weak { background-color: #ff5252; }
    .strength-medium { background-color: #ff9800; }
    .strength-strong { background-color: #4caf50; }
    .password-rules {
      font-size: 11px;
      color: #666;
      margin-top: 5px;
    }
    .password-rules li {
      margin: 2px 0;
    }
    .password-rules li.valid {
      color: #27ae60;
    }
    .password-rules li.invalid {
      color: #ff5252;
    }
  </style>
</head>
<body>
  <div class="box">
    <h2>Login</h2>
    <form id="loginForm" autocomplete="off" novalidate>
      <input id="email" name="email" type="email" placeholder="Email" required />
      <input id="password" name="password" type="password" placeholder="Password" required />
      <button type="submit">Login</button>
    </form>

    <div class="loading" id="loading">
      <div class="loading-spinner"></div>
      <p>Processing...</p>
    </div>

    <div id="errorMessage" class="error"></div>
    <div id="successMessage" class="success"></div>

    <button id="createDemo" class="demo">Create demo user and Open Dashboard</button>
    
    <!-- Toggle for signup form -->
    <button class="form-toggle" id="showSignup">Don't have an account? Register</button>
    
    <!-- Signup Form -->
    <div class="signup-form" id="signupForm">
      <form id="registerForm" autocomplete="off" novalidate>
        <input id="signupEmail" name="email" type="email" placeholder="Email" required />
        <input id="signupPassword" name="password" type="password" placeholder="Password" required />
        <div class="password-strength">
          <div class="strength-bar">
            <div class="strength-fill" id="strengthFill"></div>
          </div>
          <div class="password-rules" id="passwordRules">
            <ul>
              <li class="length">At least 8 characters</li>
              <li class="uppercase">One uppercase letter</li>
              <li class="lowercase">One lowercase letter</li>
              <li class="number">One number</li>
              <li class="special">One special character</li>
            </ul>
          </div>
        </div>
        <input id="confirmPassword" name="confirmPassword" type="password" placeholder="Confirm Password" required />
        <button type="submit">Register</button>
      </form>
      
      <button class="form-toggle" id="hideSignup" style="margin-top: 10px;">Back to Login</button>
    </div>

    <div class="note">
      This login uses Firebase Authentication for secure user management.<br>
      No local storage user data is created anymore.
    </div>
    <div class="small" id="status"></div>
  </div>

  <!-- Firebase App (core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <!-- Firebase Auth -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBcZgyw90RJPAbI2CSp-xdfY8R8T8xNPEQ",
    authDomain: "getting-b1b0a.firebaseapp.com",
    projectId: "getting-b1b0a",
    storageBucket: "getting-b1b0a.firebasestorage.app",
    messagingSenderId: "830283724536",
    appId: "1:830283724536:web:b400eda99ab1e6aad0ed0d"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const statusEl = document.getElementById("status");
    const demoBtn = document.getElementById("createDemo");
    const errorMessage = document.getElementById("errorMessage");
    const successMessage = document.getElementById("successMessage");
    const loading = document.getElementById("loading");
    const showSignupBtn = document.getElementById("showSignup");
    const hideSignupBtn = document.getElementById("hideSignup");
    const signupForm = document.getElementById("signupForm");
    const signupEmail = document.getElementById("signupEmail");
    const signupPassword = document.getElementById("signupPassword");
    const confirmPassword = document.getElementById("confirmPassword");
    const strengthFill = document.getElementById("strengthFill");
    const passwordRules = document.querySelectorAll("#passwordRules li");

    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = 'block';
      successMessage.style.display = 'none';
    }

    function showSuccess(message) {
      successMessage.textContent = message;
      successMessage.style.display = 'block';
      errorMessage.style.display = 'none';
    }

    function hideMessages() {
      errorMessage.style.display = 'none';
      successMessage.style.display = 'none';
    }

    function setLoading(isLoading) {
      loading.style.display = isLoading ? 'block' : 'none';
    }

    // Toggle between login and signup forms
    showSignupBtn.addEventListener('click', () => {
      signupForm.style.display = 'block';
      form.style.display = 'none';
      showSignupBtn.style.display = 'none';
      hideSignupBtn.style.display = 'block';
      hideMessages();
    });

    hideSignupBtn.addEventListener('click', () => {
      signupForm.style.display = 'none';
      form.style.display = 'block';
      showSignupBtn.style.display = 'block';
      hideSignupBtn.style.display = 'none';
      hideMessages();
      // Reset form
      registerForm.reset();
      updatePasswordStrength('');
    });

    // Password strength indicator
    function updatePasswordStrength(password) {
      let strength = 0;
      const rules = {
        length: password.length >= 8,
        uppercase: /[A-Z]/.test(password),
        lowercase: /[a-z]/.test(password),
        number: /[0-9]/.test(password),
        special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
      };
      
      // Update rule indicators
      passwordRules.forEach(rule => {
        const className = rule.className;
        if (rules[className]) {
          rule.classList.add('valid');
          rule.classList.remove('invalid');
          strength++;
        } else {
          rule.classList.add('invalid');
          rule.classList.remove('valid');
        }
      });
      
      // Update strength bar
      const percentage = Math.round((strength / 5) * 100);
      strengthFill.style.width = `${percentage}%`;
      
      if (strength <= 2) {
        strengthFill.className = 'strength-fill strength-weak';
      } else if (strength <= 4) {
        strengthFill.className = 'strength-fill strength-medium';
      } else {
        strengthFill.className = 'strength-fill strength-strong';
      }
    }
    
    // Add event listener for password field
    signupPassword.addEventListener('input', () => {
      updatePasswordStrength(signupPassword.value);
    });

    // Check if user is already logged in
    auth.onAuthStateChanged((user) => {
      if (user) {
        console.log("User signed in:", user.uid);
        // User is signed in, redirect to dashboard
        try {
          window.location.href = "dashboard.html";
        } catch (e) {
          console.error("Redirect failed:", e);
          alert("Redirect failed. Please check your dashboard.html file.");
        }
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMessages();
      setLoading(true);

      try {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        if (!email || !password) {
          showError("Please enter email and password");
          setLoading(false);
          return;
        }

        // Sign in with Firebase Auth
        console.log("Attempting to sign in with:", email);
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        console.log("Sign in successful:", user.uid);
        showSuccess("Login successful — redirecting...");
        
        // Check if user document exists, create if it doesn't
        const userDoc = await db.collection("users").doc(user.uid).get();
        
        if (!userDoc.exists) {
          // Create user document with default data
          await db.collection("users").doc(user.uid).set({
            email: user.email,
            displayName: user.email.split('@')[0],
            balance: 0,
            pendingDeposits: [],
            pendingWithdrawals: [],
            history: [],
            balanceVisible: true,
            currency: "USD",
            tier: 1,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        // Redirect to dashboard after a brief delay
        setTimeout(() => {
          try {
            window.location.href = "dashboard.html";
          } catch (e) {
            console.error("Redirect failed:", e);
            showError("Failed to redirect to dashboard");
          }
        }, 1000);
        
      } catch (error) {
        console.error("Login error:", error);
        console.error("Error code:", error.code);
        console.error("Error message:", error.message);
        
        // Handle specific error cases
        switch(error.code) {
          case "auth/user-not-found":
            showError("No account found with this email");
            break;
          case "auth/wrong-password":
            showError("Incorrect password");
            break;
          case "auth/invalid-email":
            showError("Invalid email address");
            break;
          case "auth/too-many-requests":
            showError("Too many failed attempts. Please try again later.");
            break;
          default:
            showError("Login failed: " + error.message);
        }
      } finally {
        setLoading(false);
      }
    });

    // Enhanced registration form
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      hideMessages();
      setLoading(true);

      try {
        const email = signupEmail.value.trim();
        const password = signupPassword.value.trim();
        const confirmPasswordValue = confirmPassword.value.trim();

        // Validate inputs
        if (!email || !password || !confirmPasswordValue) {
          showError("All fields are required");
          setLoading(false);
          return;
        }

        if (password !== confirmPasswordValue) {
          showError("Passwords don't match");
          setLoading(false);
          return;
        }

        if (password.length < 8) {
          showError("Password must be at least 8 characters long");
          setLoading(false);
          return;
        }

        // Check password complexity
        const hasUppercase = /[A-Z]/.test(password);
        const hasLowercase = /[a-z]/.test(password);
        const hasNumber = /[0-9]/.test(password);
        const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
        
        if (!(hasUppercase && hasLowercase && hasNumber && hasSpecial)) {
          showError("Password must contain uppercase, lowercase, number, and special character");
          setLoading(false);
          return;
        }

        // Create user with Firebase Auth
        console.log("Attempting to create user with:", email);
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        console.log("User created successfully:", user.uid);
        
        // Create user document in Firestore
        await db.collection("users").doc(user.uid).set({
          email: user.email,
          displayName: user.email.split('@')[0],
          balance: 0,
          pendingDeposits: [],
          pendingWithdrawals: [],
          history: [],
          balanceVisible: true,
          currency: "USD",
          tier: 1,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showSuccess("Account created successfully! You can now login.");
        
        // Reset form and switch back to login
        registerForm.reset();
        updatePasswordStrength('');
        signupForm.style.display = 'none';
        form.style.display = 'block';
        showSignupBtn.style.display = 'block';
        hideSignupBtn.style.display = 'none';
        
        // Pre-fill the email field in login form
        document.getElementById("email").value = email;
        
      } catch (error) {
        console.error("Registration error:", error);
        console.error("Error code:", error.code);
        console.error("Error message:", error.message);
        
        switch(error.code) {
          case "auth/email-already-in-use":
            showError("This email is already registered");
            break;
          case "auth/invalid-email":
            showError("Invalid email address");
            break;
          case "auth/weak-password":
            showError("Password is too weak. Use at least 8 characters with uppercase, lowercase, number, and special character");
            break;
          case "auth/network-request-failed":
            showError("Network error. Please check your connection and try again.");
            break;
          default:
            showError("Registration failed: " + error.message);
        }
      } finally {
        setLoading(false);
      }
    });

    // Demo button to quickly create a sample user and go to dashboard
    demoBtn.addEventListener("click", async () => {
      hideMessages();
      setLoading(true);
      
      try {
        const demoEmail = "demo@example.com";
        const demoPassword = "demopassword123";
        
        // Try to sign in with demo account
        try {
          await auth.signInWithEmailAndPassword(demoEmail, demoPassword);
        } catch (signInError) {
          if (signInError.code === "auth/user-not-found") {
            // Create demo account if it doesn't exist
            const userCredential = await auth.createUserWithEmailAndPassword(demoEmail, demoPassword);
            const user = userCredential.user;
            
            // Create demo user document
            await db.collection("users").doc(user.uid).set({
              email: user.email,
              displayName: "Demo User",
              balance: 930000,
              pendingDeposits: [
                { amount: 60000, status: "pending", date: new Date().toISOString() }
              ],
              pendingWithdrawals: [
                { amount: 5700, status: "pending", date: new Date().toISOString() }
              ],
              history: [
                { action: "Demo account created", date: new Date().toISOString() }
              ],
              balanceVisible: true,
              currency: "EUR",
              tier: 1,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } else {
            throw signInError;
          }
        }
        
        showSuccess("Demo login successful — redirecting...");
        setTimeout(() => {
          try {
            window.location.href = "dashboard.html";
          } catch (e) {
            console.error("Redirect failed:", e);
            showError("Failed to redirect to dashboard");
          }
        }, 1000);
        
      } catch (error) {
        console.error("Demo login error:", error);
        showError("Demo login failed: " + error.message);
        setLoading(false);
      }
    });
  });
  </script>
</body>
</html>
